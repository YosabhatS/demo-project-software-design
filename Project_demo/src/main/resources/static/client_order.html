<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* CSS Styling ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 600px; margin: 0 auto; padding: 15px 15px 80px 15px; background: #f8f8f8; }
        .header { background-color: #007bff; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .menu-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .item-details h3 { margin: 0 0 5px 0; color: #333; }
        .item-details p { margin: 0; color: #555; font-size: 0.9em; }
        .controls { display: flex; align-items: center; }
        .controls button { background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-weight: bold; margin: 0 5px; }
        .controls input { width: 40px; text-align: center; border: 1px solid #ccc; border-radius: 4px; padding: 5px; }
        .controls button.add { background: #28a745; }
        #order-summary { position: fixed; bottom: 0; left: 0; right: 0; background-color: #343a40; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); }
        #order-summary button { background: #ffc107; color: #333; border: none; padding: 10px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .log-message { margin-top: 15px; padding: 10px; border-radius: 5px; }
        .log-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .log-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>

    <div class="header">
        <h1>‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ - ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>
        <p>‡πÇ‡∏ï‡πä‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: <strong id="tableIdDisplay">--</strong></p>
    </div>

    <div id="menuList">
        <h2>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2>
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...</p>
    </div>

    <div id="order-summary">
        <div>
            <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: <strong id="totalItemsDisplay">0</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </div>
        <button onclick="submitOrder()">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
    </div>

    <div class="log-message" id="log"></div>

    <script>
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î URL ‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á API Gateway (Project Web: 8082)
        const ORDER_API_URL = 'http://localhost:8082/api/orders'; 
        
        // ‡∏î‡∏∂‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞ (tableId) ‡∏à‡∏≤‡∏Å URL Parameter
        const TABLE_ID = new URLSearchParams(window.location.search).get('tableId');
        
        let menuItems = [];   // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å API
        let orderItems = {};  // { menuId: quantity, ... } ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

        // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà Header
        document.getElementById('tableIdDisplay').innerText = TABLE_ID || '‡πÑ‡∏°‡πà‡∏û‡∏ö';

        // ----------------------------------------------------------------------
        // 1. Function ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π (‡∏ú‡πà‡∏≤‡∏ô API Gateway: 8082)
        // ----------------------------------------------------------------------
        async function fetchMenuItems() {
            if (!TABLE_ID) {
                logMessage('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÉ‡∏´‡∏°‡πà', true);
                return;
            }
            
            try {
                // üí° ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Endpoint ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô OrderController (Port 8082)
                const MENU_API_URL = `${ORDER_API_URL}/menu`; 
                
                const response = await fetch(MENU_API_URL);
                
                if (response.ok) {
                    menuItems = await response.json(); // ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö List/Array ‡∏Ç‡∏≠‡∏á MenuItemDTO
                    renderMenu();
                } else if (response.status === 503) {
                     logMessage(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ: Data Service (8085) ‡∏•‡πà‡∏° Status: ${response.status}`, true);
                }
                else {
                    logMessage(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ: Status ${response.status}. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Project Web (8082)`, true);
                }

            } catch (error) {
                logMessage(`‚ùå Network Error: ${error.message}. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Project Web (8082) ‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà`, true);
            }
        }

        // ----------------------------------------------------------------------
        // 2. Function ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏°‡∏ô‡∏π
        // ----------------------------------------------------------------------
        function renderMenu() {
            const listElement = document.getElementById('menuList');
            let html = '<h2>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2>';
            
            if (menuItems.length === 0) {
                 listElement.innerHTML = '<h2>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ô Data Service (Port 8085)</p>';
                 return;
            }
            
            menuItems.forEach(item => {
                const currentQuantity = orderItems[item.id] || 0;
                html += `
                    <div class="menu-item">
                        <div class="item-details">
                            <h3>${item.name}</h3>
                            <p>‡∏£‡∏´‡∏±‡∏™: ${item.id} | ‡∏£‡∏≤‡∏Ñ‡∏≤: ${item.price ? item.price.toFixed(2) : 'N/A'} ‡∏ö‡∏≤‡∏ó</p>
                        </div>
                        <div class="controls">
                            <button onclick="updateQuantity(${item.id}, -1)">-</button>
                            <input type="number" id="qty-${item.id}" value="${currentQuantity}" readonly data-menu-id="${item.id}">
                            <button class="add" onclick="updateQuantity(${item.id}, 1)">+</button>
                        </div>
                    </div>
                `;
            });
            listElement.innerHTML = html;
            updateSummary();
        }

        // ----------------------------------------------------------------------
        // 3. Function ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î)
        // ----------------------------------------------------------------------
        function updateQuantity(menuId, change) {
            const inputElement = document.getElementById(`qty-${menuId}`);
            let newQty = (orderItems[menuId] || 0) + change;
            
            if (newQty < 0) newQty = 0;

            orderItems[menuId] = newQty;
            inputElement.value = newQty;
            
            if (newQty === 0) {
                delete orderItems[menuId]; // ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0
            }

            updateSummary();
        }

        // ----------------------------------------------------------------------
        // 4. Function ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        // ----------------------------------------------------------------------
        function updateSummary() {
            const totalItems = Object.values(orderItems).reduce((sum, qty) => sum + qty, 0);
            document.getElementById('totalItemsDisplay').innerText = totalItems;
        }

        // ----------------------------------------------------------------------
        // 5. Function ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (POST ‡πÑ‡∏õ‡∏¢‡∏±‡∏á API Gateway: 8082)
        // ----------------------------------------------------------------------
        async function submitOrder() {
            const items = Object.entries(orderItems)
                .map(([menuId, quantity]) => ({ menuId: parseInt(menuId), quantity }))
                .filter(item => item.quantity > 0);

            if (items.length === 0) {
                logMessage('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', true);
                return;
            }

            const requestBody = { tableId: parseInt(TABLE_ID), items };
            logMessage(`‚ñ∂Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏ï‡πä‡∏∞ ${TABLE_ID}...`);

            try {
                // üí° ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API Gateway ‡∏ó‡∏µ‡πà Port 8082
                const response = await fetch(ORDER_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const responseJson = await response.json();
                
                if (response.status === 201) {
                    logMessage(`‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! Order ID: ${responseJson.id}`, false);
                    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á
                    orderItems = {};
                    renderMenu(); 
                } else if (response.status === 404) {
                     logMessage(`‚ùå ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! Menu ID ‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ö‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`, true);
                } else if (response.status === 503) {
                     logMessage(`‚ùå ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! Data Service (8085) ‡∏•‡πà‡∏°`, true);
                } 
                else {
                    logMessage(`‚ùå ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${response.status}. ${JSON.stringify(responseJson)}`, true);
                }
            } catch (error) {
                logMessage(`‚ùå Network Error: ${error.message}. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Project Web (8082) ‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà`, true);
            }
        }

        // ----------------------------------------------------------------------
        // 6. Utility: Log Message
        // ----------------------------------------------------------------------
        function logMessage(message, isError = false) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('th-TH');
            logElement.className = isError ? 'log-message log-error' : 'log-message log-success';
            logElement.innerHTML = `[${timestamp}] ${message}`;
        }
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        document.addEventListener('DOMContentLoaded', fetchMenuItems);
    </script>
</body>
</html>